import * as database from "./bot/database.js";
import "dotenv/config";
import { LavaPayment } from "./bot/payments.js";
import { processChannelJoinRequest, subscriptionMap } from "./bot/tools.js";
import "./bot/cron/mainCron.js";
import "./bot/server.js";
import { bot } from "./bot/bot.js";

const lavaApi = new LavaPayment(
  process.env.LAVA_SHOP_ID,
  process.env.LAVA_SECRET_KEY,
  process.env.LAVA_SHOP_NAME
);

 bot.onText(/\/privacy/, async (msg) => {
    const chatId = msg.chat.id;
    bot.sendMessage(
      chatId,
      `–ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ Telegram –±–æ—Ç–∞ @TravelShopAnanasik_bot\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏—è Telegram –±–æ—Ç–∞ @TravelShopAnanasik_bot –æ–±—è–∑—É–µ—Ç—Å—è —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤–∞—à—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –≤ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–µ. –ú—ã —É–¥–µ–ª—è–µ–º –±–æ–ª—å—à–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –æ—Ö—Ä–∞–Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –≤–∞–º–∏ –¥–∞–Ω–Ω—ã—Ö. –ù–∞—à–∞ –ø–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è—Ö –ø–æ–ª–∏—Ç–∏–∫ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ Telegram –∏ –º–∞–≥–∞–∑–∏–Ω–æ–≤ Apple –∏ Google.\n–ú—ã –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –∏ –Ω–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ù–∞—à Telegram –±–æ—Ç –≤ —Ü–µ–ª—è—Ö –æ—Å—É—â–µ—Å—Ç–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã —Å–µ—Ä–≤–∏—Å–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–µ–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π Telegram ID.\n\n–°–±–æ—Ä –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö\n–ú—ã –Ω–µ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏ –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –Ω–∏–∫–∞–∫–∏—Ö –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö. –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –Ω–∞—à–µ–º —Å–µ—Ä–≤–∏—Å–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã —Ç–æ–ª—å–∫–æ –∫ –Ω–µ–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º—É Telegram ID.\n–ö–æ–≥–¥–∞ –≤—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ Telegram –±–æ—Ç @TravelShopAnanasik_bot, Telegram –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –Ω–∞–º —Ç–æ–ª—å–∫–æ –≤–∞—à Telegram ID, –∫–æ—Ç–æ—Ä—ã–π –Ω–µ –¥–∞–µ—Ç –Ω–∞–º –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–∞—à–µ–π –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n–•—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö, –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∏ —É–¥–∞–ª–µ–Ω–∏–µ\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–≤—à–∏–π —Å–≤–æ–π Telegram-ID –Ω–∞—à–µ–º—É Telegram –±–æ—Ç—É @TravelShopAnanasik_bot –∏–º–µ–µ—Ç –ø—Ä–∞–≤–æ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ —Å–≤–æ–∏—Ö –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã—Ö –∫ Telegram ID, –∫—Ä–æ–º–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.\n\n–†–∞—Å–∫—Ä—ã—Ç–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º\n–ú—ã –Ω–µ –ø—Ä–æ–¥–∞–µ–º, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º –∏ –Ω–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ–º —Ç—Ä–µ—Ç—å–∏–º –ª–∏—Ü–∞–º –∫–∞–∫–∏–µ-–ª–∏–±–æ –¥–∞–Ω–Ω—ã–µ —Å–≤–æ–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –∫–∞–∫–∏—Ö-–ª–∏–±–æ —Ü–µ–ª–µ–π.\n\n–ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–µ—Ç—è–º\n–ï—Å–ª–∏ –≤—ã —è–≤–ª—è–µ—Ç–µ—Å—å —Ä–æ–¥–∏—Ç–µ–ª–µ–º –∏–ª–∏ –æ–ø–µ–∫—É–Ω–æ–º, –∏ –≤—ã –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –≤–∞—à–∏ –¥–µ—Ç–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∞–º —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –≤–∞—à–µ–≥–æ —Å–æ–≥–ª–∞—Å–∏—è, —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏.\n\n–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø–æ–ª–∏—Ç–∏–∫–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏\nTelegram –±–æ—Ç @TravelShopAnanasik_bot –º–æ–∂–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω–∞—à—É –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –≤—Ä–µ–º—è –æ—Ç –≤—Ä–µ–º–µ–Ω–∏. –ú—ã —Å–æ–æ–±—â–∞–µ–º –æ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö, —Ä–∞–∑–º–µ—Å—Ç–∏–≤ –Ω–æ–≤—É—é –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ. –ï—Å–ª–∏ –≤—ã –æ—Å—Ç–∞–≤–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —É –Ω–∞—Å, —Ç–æ –º—ã –æ–ø–æ–≤–µ—Å—Ç–∏–º –≤–∞—Å –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ –ø–æ–ª–∏—Ç–∏–∫–µ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –±–æ—Ç–∞ @TravelShopAnanasik_bot.\n\n–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å, –∑–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª–æ–∂–µ–Ω–∏—è\n–°–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ü–∏–µ–π Telegram –±–æ—Ç–∞ @TravelShopAnanasik_bot –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º, —Å–≤—è–∑–∞–Ω–Ω—ã–º —Å –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –º–æ–∂–Ω–æ —Å –ø–æ–º–æ—â—å—é –∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ —É–∫–∞–∑–∞–Ω–Ω–æ–π –≤ —Ä–∞–∑–¥–µ–ª–µ –ü–æ–º–æ—â—å –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞. –ï—Å–ª–∏ –≤—ã –Ω–µ —Å–æ–≥–ª–∞—Å–Ω—ã —Å –¥–∞–Ω–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏, –≤—ã –Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —É—Å–ª—É–≥–∞–º–∏ Telegram –±–æ—Ç–∞ @TravelShopAnanasik_bot.\n\n–ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤\n–ù–∞—Å—Ç–æ—è—â–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ —Ä–µ–≥—É–ª–∏—Ä—É–µ—Ç —É—Å–ª–æ–≤–∏—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –ø–ª–∞—Ç–Ω—É—é –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ –Ω–∞—à —Å–µ—Ä–≤–∏—Å. –û—Ñ–æ—Ä–º–ª—è—è –ø–æ–¥–ø–∏—Å–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å –¥–∞–Ω–Ω–æ–π –ø–æ–ª–∏—Ç–∏–∫–æ–π Telegram –±–æ—Ç–∞ @TravelShopAnanasik_bot. –ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º 14-–¥–Ω–µ–≤–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Ä–µ–¥—Å—Ç–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–µ—Ä–≤–æ–π –æ–ø–ª–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏, –µ—Å–ª–∏ —É—Å–ª—É–≥–∞–º–∏ –Ω–µ –ø–æ–ª—å–∑–æ–≤–∞–ª–∏—Å—å. –î–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥ –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É. –ï—Å–ª–∏ —Å–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–µ—Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–µ–Ω –±–æ–ª–µ–µ 24 —á–∞—Å–æ–≤, –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—Ä–æ—Å–∏—Ç—å:\n!–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ —Å—Ä–æ–∫ –ø—Ä–æ—Å—Ç–æ—è\n!–ß–∞—Å—Ç–∏—á–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç –∑–∞ –Ω–µ—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏\n!–ü–æ–ª–Ω—ã–π –≤–æ–∑–≤—Ä–∞—Ç, –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞ –≤ —Ä–∞–∑—É–º–Ω—ã–µ —Å—Ä–æ–∫–∏\n\n–í–æ–∑–≤—Ä–∞—Ç —Å—Ä–µ–¥—Å—Ç–≤ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –¥–æ 10 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π –ø–æ —Ä–µ–∫–≤–∏–∑–∏—Ç–∞–º —Å –∫–æ—Ç–æ—Ä—ã—Ö –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∞ –æ–ø–ª–∞—Ç–∞. –ú—ã –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–æ –∏–∑–º–µ–Ω—è—Ç—å —É—Å–ª–æ–≤–∏—è. –ê–∫—Ç—É–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ –Ω–∞ –¥–∞–Ω–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ. `,
      {
        parse_mode: "HTML",
        reply_markup: {
          inline_keyboard: [
            [{ text: "–ù–∞—á–∞—Ç—å", url: "https://t.me/TravelShopAnanasik_bot?start=1" }],
          ],
        },
      }
    );
  });

  bot.onText(/\/support/, async (msg) => {
      const chatId = msg.chat.id;
      bot.sendMessage(
        chatId,
        `–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å @webmikefox`,
        {
          parse_mode: "HTML",
          reply_markup: {
            inline_keyboard: [
              [{ text: "–ù–∞—á–∞—Ç—å", url: "https://t.me/TravelShopAnanasik_bot?start=1" }],
            ],
          },
        }
      );
    });

bot.onText(/\/admin/, async (msg) => {
  const chatId = msg.chat.id;
  if (chatId == process.env.ADMIN_IDS)
    bot.sendMessage(chatId, "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –ø–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞", {
      reply_markup: {
        inline_keyboard: [
          [
            {
              text: "–û—Ç—á–µ—Ç –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º",
              callback_data: "Adm_report",
            }],[
            {
              text: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
              callback_data: "Adm_notification",
            },
          ],
        ],
      },
    });
});

bot.onText(/\/start/, async (msg) => {
  const chatId = msg.chat.id;
  const userIndb = await database.approveUser(chatId);
  if (userIndb !== null) {
    if (userIndb.userActive) {
      const dataSubscriptionEnd = userIndb.subscriptionEnd;
      bot.sendMessage(
        chatId,
        `–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ ${dataSubscriptionEnd}. –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É /start –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏`
      );
    } else {
      bot.sendMessage(
        chatId,
        "–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞, –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ—Å—É—Ä—Å—É –ø—Ä–µ–æ–±—Ä–µ—Ç–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –∑–∞–Ω–æ–≤–æ.",
        {
          reply_markup: {
            inline_keyboard: [
              [
                { text: "1 –ú–ï–°–Ø–¶", callback_data: "buy_subscriptionOne" },
                {
                  text: "2 –ú–ï–°–Ø–¶–ê üî• -5%",
                  callback_data: "buy_subscriptionTwo",
                },
              ],
              [
                {
                  text: "3 –ú–ï–°–Ø–¶–ê üî• -8%",
                  callback_data: "buy_subscriptionThree",
                },
                {
                  text: "6 –ú–ï–°–Ø–¶–ï–í üî• -15%",
                  callback_data: "buy_subscriptionSix",
                },
              ],
              [
                {
                  text: "12 –ú–ï–°–Ø–¶–ï–í üî• -20%",
                  callback_data: "buy_subscriptionTwelve",
                },
              ],
            ],
          },
        }
      );
    }
  } else {
    bot.sendMessage(
      chatId,
      "üí∞ –ö—É–ø–∏—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–Ω–∞–ª—É!",
      {
        reply_markup: {
          inline_keyboard: [
            [
              { text: "1 –ú–ï–°–Ø–¶", callback_data: "buy_subscriptionOne" },
              { text: "2 –ú–ï–°–Ø–¶–ê üî• -5%", callback_data: "buy_subscriptionTwo" },
            ],
            [
              {
                text: "3 –ú–ï–°–Ø–¶–ê üî• -8%",
                callback_data: "buy_subscriptionThree",
              },
              {
                text: "6 –ú–ï–°–Ø–¶–ï–í üî• -15%",
                callback_data: "buy_subscriptionSix",
              },
            ],
            [
              {
                text: "12 –ú–ï–°–Ø–¶–ï–í üî• -20%",
                callback_data: "buy_subscriptionTwelve",
              },
            ],
          ],
        },
      }
    );
  }
});

bot.on("chat_join_request", async (update) => {
  console.log("–ü–æ–ª—É—á–µ–Ω–∞ –Ω–æ–≤–∞—è –∑–∞—è–≤–∫–∞:", update);
  const statusUser = await database.approveUser(update.user_chat_id);
  if (statusUser.userActive) {
    await processChannelJoinRequest(update, true);

  }
  return;
});

bot.on("callback_query", async (query) => {
  try {
    const sub = subscriptionMap[query.data];
    if (!sub) return;
    const dataInvoice = await lavaApi.createInvoice({
      shopId: process.env.LAVA_SHOP_ID,
      sum: sub.sum,
      orderId: `${query.message.chat.id}_${Date.now()}`,
      expire: 5,
      customFields: query.message.chat.id,
    });
    bot.deleteMessage(query.message.chat.id, query.message.message_id);
    bot.sendMessage(
      query.message.chat.id,
      `üîó –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã: ${dataInvoice.data.url}`
    );
  } catch (error) {
    console.log(error);
  }
});
